name: Deploy Menu Development
run-name: Deploy to ${{ inputs.gyg_region }} / ${{ inputs.gyg_env }} - ${{ inputs.prefix_region }} - ${{ inputs.tag_version }} by @${{ github.actor }}

permissions: write-all

on:
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Release version to deploy (e.g. v0.0.1, or v0.0.1-branch-name.0)"
        required: true
      gyg_env:
        description: "GYG_ENV (test)"
        required: true
        default: "test"
        type: choice
        options:
          - test
      gyg_region:
        description: "GYG_REGION (singapore)"
        required: true
        default: "singapore"
        type: choice
        options:
          - singapore
      ignore_migration_check:
        description: "Ignore migrations check - WARNING, proceed at risk"
        required: true
        default: 'false'
        type: choice
        options:
          - false
          - true
      prefix_region:
        description: "Prefix region (au, us). Prefix = region + repo's name. Eg: au-menu, us-task"
        required: true
        default: "au"
        type: choice
        options:
          - au
          - us
  workflow_call:
    inputs:
      tag_version:
        description: "Release version to deploy (e.g. v0.0.1, or v0.0.1-branch-name.0)"
        required: true
        type: string
      gyg_env:
        description: "GYG_ENV (test)"
        required: true
        default: "test"
        type: string
      gyg_region:
        description: "GYG_REGION (australia, usa, singapore)"
        required: true
        default: "singapore"
        type: string
      ignore_migration_check:
        description: "Ignore migrations check - WARNING, proceed at risk"
        required: true
        default: false
        type: string
      prefix_region:
        description: "Prefix region (au, us). Prefix = region + repo's name. Eg: au-menu, us-task"
        required: true
        default: "au"
        type: string

jobs:
  Setup-Database-Outputs:
    runs-on: ubuntu-latest
    continue-on-error: true

    outputs:
      vpn_profile_secret_key: ${{ steps.get-db-outputs.outputs.vpn_profile_secret_key }}
      db_username_secret_key: ${{ steps.get-db-outputs.outputs.db_username_secret_key }}
      db_password_secret_key: ${{ steps.get-db-outputs.outputs.db_password_secret_key }}
      db_host_secret_key: ${{ steps.get-db-outputs.outputs.db_host_secret_key }}
    steps:
      - id: get-db-outputs
        name: Get Database Outputs
        uses: guzmanygomez/github-actions/get-database-outputs@main
        with:
          gyg_env: ${{ inputs.gyg_env }}
          gyg_region: ${{ inputs.gyg_region }}

  Deploy-Feature:
    needs:
      - Setup-Database-Outputs
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Pin Node to 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTION_ROLE_APPS_TEST }}
          role-session-name: github-action
          aws-region: "ap-southeast-1"

      - name: Set up AWS CodeArtifact
        uses: guzmanygomez/github-actions/code-artifact@main
        env:
          AWS_REGION: "ap-southeast-2"

      - name: Extract branch name
        shell: bash
        run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
        id: extract_branch

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.extract_branch.outputs.branch }}

      - name: Extract part of the repository name
        id: extract_repo_name
        shell: bash
        run: echo "repo_name=$(echo ${GITHUB_REPOSITORY#guzmanygomez/bhyve-feature-})" >> $GITHUB_OUTPUT

      - name: Install Node Modules
        run: yarn install

      - name: Check migration
        if: inputs.ignore_migration_check == 'false' && inputs.gyg_env == 'prod'
        uses: guzmanygomez/github-actions/diff-migrations@main
        with:
          vpn_profile: ${{ secrets[needs.Setup-Database-Outputs.outputs.vpn_profile_secret_key] }}
          db_username: ${{ secrets[needs.Setup-Database-Outputs.outputs.db_username_secret_key] }}
          db_password: ${{ secrets[needs.Setup-Database-Outputs.outputs.db_password_secret_key] }}
          db_host: ${{ secrets[needs.Setup-Database-Outputs.outputs.db_host_secret_key] }}
          gyg_env: ${{ inputs.gyg_env }}
          gyg_region: ${{ inputs.gyg_region}}

      - name: Set up AWS Test
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTION_ROLE_APPS_TEST }}
          role-session-name: github-action
          aws-region: ${{ secrets.AWS_TEST_DEPLOY_REGION }}

      - name: Deploy release package
        uses: guzmanygomez/github-actions/release-deploy-v2@main
        with:
          gyg_env: ${{ inputs.gyg_env }}
          gyg_region: ${{ inputs.gyg_region }}
          version: ${{ inputs.tag_version }}
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
          prefix_region: ${{ inputs.prefix_region }}-${{ steps.extract_repo_name.outputs.repo_name }}
