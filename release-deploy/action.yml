name: "Release deploy"
description: "download packages and deploy"
inputs:
  gyg_env:
    required: true
  gyg_region:
    required: true
  version:
    required: true
  branch:
    required: false
runs:
  using: "composite"
  steps:
    - run: |
        if ! [[ "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; 
        then
          echo "version needs to be of format v*.*.* where * is a digit. e.g. v0.3.2";
          exit 1;
        fi
      shell: bash
    - run: |
        echo ${{ github.token }} | gh auth login --with-token
        zipName="*-${{ inputs.gyg_env }}-${{ inputs.gyg_region }}-${{ inputs.version }}"
        if [[ -n "${{ inputs.branch }}" ]]; then
          zipName="$zipName-${{ inputs.branch }}";
        fi
        zipName="${zipName}.zip"
        msg="Downloading artifact '$zipName' for deployment"
        echo $msg
        gh release download -p $zipName ${{ inputs.version }}
      shell: bash
    - env:
        GYG_ENV: ${{ inputs.gyg_env }}
        GYG_REGION: ${{ inputs.gyg_region }}
        RELEASE_VERSION: ${{ inputs.version }}
        BRANCH: ${{ inputs.branch }}
      run: |
        yarn release:diff || true
        yarn release:deploy
      shell: bash
    
